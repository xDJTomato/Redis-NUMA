# Composite LRUç­–ç•¥æµ‹è¯•è„šæœ¬ä½¿ç”¨è¯´æ˜

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»„ç»‡

é¡¹ç›®æµ‹è¯•æ–‡ä»¶å·²æ¨¡å—åŒ–æ•´ç†ï¼Œè¯¦è§å„ç›®å½•READMEï¼š

- **[tests/numa/](tests/numa/README.md)** - NUMA åŠŸèƒ½æµ‹è¯•ï¼ˆæ¨èæ—¥å¸¸ä½¿ç”¨ï¼‰
- **[tests/ycsb/](tests/ycsb/README.md)** - YCSB å‹åŠ›æµ‹è¯•ï¼ˆæ¨èæ€§èƒ½è¯„ä¼°ï¼‰
- **[tests/legacy/](tests/legacy/README.md)** - å†å²æµ‹è¯•æ–‡ä»¶å½’æ¡£

## æµ‹è¯•è„šæœ¬è¯´æ˜

æœ¬æ–‡æ¡£ä»‹ç» Composite LRU ç­–ç•¥çš„ä¸¤ä¸ªæµ‹è¯•è„šæœ¬ï¼ˆä½äº [tests/numa/](tests/numa/)ï¼‰ï¼š

| è„šæœ¬ | ç”¨é€” | é€‚ç”¨ç¯å¢ƒ |
|-----|------|---------|
| `test_composite_lru.sh` | é€šç”¨åŠŸèƒ½æµ‹è¯• | ä»»ä½•Linuxç¯å¢ƒ |
| `test_composite_lru_cxl.sh` | CXLä¸“ç”¨æµ‹è¯• | å¸¦CXLè®¾å¤‡çš„è™šæ‹Ÿæœº/ç‰©ç†æœº |

---

## å¿«é€Ÿå¼€å§‹

### 1. é€šç”¨åŠŸèƒ½æµ‹è¯•è„šæœ¬

**åŸºæœ¬ç”¨æ³•ï¼š**
```bash
# é»˜è®¤å‚æ•°ï¼ˆç«¯å£6379ï¼Œæµ‹è¯•60ç§’ï¼‰
./test_composite_lru.sh

# æŒ‡å®šç«¯å£å’Œæµ‹è¯•æ—¶é•¿
./test_composite_lru.sh 6379 120
```

**æµ‹è¯•å†…å®¹ï¼š**
1. âœ… RedisæœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
2. âœ… Composite LRUç­–ç•¥åŠ è½½éªŒè¯
3. âœ… åŸºç¡€æ•°æ®æ“ä½œï¼ˆSTRING/HASH/LIST/SET/ZSETï¼‰
4. âœ… çƒ­åº¦è¿½è¸ªæµ‹è¯•ï¼ˆæ¨¡æ‹Ÿçƒ­ç‚¹/å†·keyè®¿é—®ï¼‰
5. âœ… NUMAè¿ç§»å‘½ä»¤æµ‹è¯•ï¼ˆNUMAMIGRATEï¼‰
6. âœ… CXLè®¾å¤‡æ£€æµ‹
7. âœ… å‹åŠ›æµ‹è¯•ï¼ˆæŒç»­æŒ‡å®šç§’æ•°ï¼‰
8. âœ… ç­–ç•¥æ‰§è¡Œæ—¥å¿—æ£€æŸ¥
9. âœ… å†…å­˜ä½¿ç”¨æ£€æŸ¥
10. âœ… æµ‹è¯•æ•°æ®æ¸…ç†

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
========================================
Composite LRUç­–ç•¥å®Œæ•´æµ‹è¯•è„šæœ¬
========================================

[INFO] æ£€æŸ¥RedisæœåŠ¡å™¨çŠ¶æ€...
[PASS] RedisæœåŠ¡å™¨è¿è¡Œæ­£å¸¸
[INFO] æµ‹è¯•1: æ£€æŸ¥Composite LRUç­–ç•¥æ˜¯å¦åŠ è½½...
[PASS] Composite LRUç­–ç•¥å·²æ­£ç¡®åŠ è½½åˆ°slot 1
...
[PASS] æ‰€æœ‰æµ‹è¯•å®Œæˆï¼è¯¦ç»†æ—¥å¿—è§: /tmp/composite_lru_test.log
```

---

### 2. CXLä¸“ç”¨æµ‹è¯•è„šæœ¬

**åŸºæœ¬ç”¨æ³•ï¼š**
```bash
# é»˜è®¤å‚æ•°ï¼ˆç«¯å£6379ï¼Œæµ‹è¯•120ç§’ï¼‰
./test_composite_lru_cxl.sh

# æŒ‡å®šç«¯å£å’Œæµ‹è¯•æ—¶é•¿
./test_composite_lru_cxl.sh 6379 300
```

**CXLä¸“ç”¨æµ‹è¯•å†…å®¹ï¼š**
1. âœ… ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥ï¼ˆå†…æ ¸ç‰ˆæœ¬ã€CPUã€å†…å­˜ï¼‰
2. âœ… **CXLè®¾å¤‡æ£€æµ‹**ï¼ˆæ€»çº¿ã€è®¾å¤‡ã€å†…å­˜åŒºåŸŸï¼‰
3. âœ… NUMAæ‹“æ‰‘åˆ†æ
4. âœ… **CXLæ„ŸçŸ¥æ•°æ®åˆ›å»º**ï¼ˆå°/ä¸­/å¤§å¯¹è±¡æ¨¡æ‹Ÿå†…å­˜å±‚çº§ï¼‰
4. âœ… **CXLè®¿é—®æ¨¡å¼æ¨¡æ‹Ÿ**ï¼ˆçƒ­ç‚¹/æ¸©æ•°æ®/å†·æ•°æ®ï¼‰
5. âœ… NUMAè¿ç§»åŠŸèƒ½æµ‹è¯•
6. âœ… **CXLæ€§èƒ½æµ‹è¯•**ï¼ˆæ··åˆè®¿é—®æ¨¡å¼ï¼ŒæŒç»­æŒ‡å®šç§’æ•°ï¼‰
7. âœ… è¯¦ç»†æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

**CXLç¯å¢ƒè¦æ±‚ï¼š**
- Linuxå†…æ ¸ >= 5.12ï¼ˆæ¨è >= 6.0ï¼‰
- å¯ç”¨CXLæ”¯æŒï¼š`CONFIG_CXL_BUS=y`
- åŠ è½½CXLæ¨¡å—ï¼š`modprobe cxl`
- ï¼ˆå¯é€‰ï¼‰numactlå·¥å…·ç”¨äºNUMAåˆ†æ

---

## åœ¨CXLè™šæ‹Ÿæœºä¸Šæµ‹è¯•æ­¥éª¤

### æ­¥éª¤1ï¼šå‡†å¤‡ç¯å¢ƒ

```bash
# 1. ç™»å½•CXLè™šæ‹Ÿæœº
ssh user@cxl-vm-ip

# 2. æ£€æŸ¥CXLæ”¯æŒ
ls /sys/bus/cxl  # åº”è¯¥å­˜åœ¨æ­¤ç›®å½•

# 3. æ£€æŸ¥CXLè®¾å¤‡
ls /sys/bus/cxl/devices/

# 4. æ£€æŸ¥NUMAæ”¯æŒ
numactl --hardware
```

### æ­¥éª¤2ï¼šéƒ¨ç½²Redis

```bash
# 1. å¤åˆ¶Redisæºç åˆ°è™šæ‹Ÿæœº
scp -r redis-CXL-in-v6.2.21 user@cxl-vm-ip:~/

# 2. åœ¨è™šæ‹Ÿæœºä¸Šç¼–è¯‘
cd ~/redis-CXL-in-v6.2.21
make clean && make -j4

# 3. éªŒè¯ç¼–è¯‘ç»“æœ
./src/redis-server --version
```

### æ­¥éª¤3ï¼šè¿è¡Œæµ‹è¯•

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨CXLä¸“ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰
./test_composite_lru_cxl.sh 6379 300

# æ–¹æ³•2ï¼šä½¿ç”¨é€šç”¨è„šæœ¬
./test_composite_lru.sh 6379 120
```

### æ­¥éª¤4ï¼šæŸ¥çœ‹ç»“æœ

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
cat /tmp/composite_lru_cxl_test.log

# æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
cat /tmp/composite_lru_cxl_result.txt

# æŸ¥çœ‹Redisæ—¥å¿—
grep "Composite LRU\|NUMA Strategy" /tmp/redis-*.log
```

---

## é¢„æœŸæµ‹è¯•ç»“æœ

### æ­£å¸¸æƒ…å†µ

```
[PASS] RedisæœåŠ¡å™¨è¿è¡Œæ­£å¸¸
[PASS] Composite LRUç­–ç•¥å·²æ­£ç¡®åŠ è½½åˆ°slot 1
[PASS] STRING/HASH/LIST/SET/ZSETæ“ä½œæ­£å¸¸
[PASS] NUMAMIGRATEå‘½ä»¤æ­£å¸¸
[PASS] å•keyè¿ç§»æˆåŠŸ
[PASS] è¿ç§»åæ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡
[PASS] CXLæ€§èƒ½æµ‹è¯•å®Œæˆ
```

### CXLè®¾å¤‡æ£€æµ‹

**æœ‰CXLè®¾å¤‡æ—¶ï¼š**
```
[PASS] CXLæ€»çº¿å·²å¯ç”¨
[CXL] CXLè®¾å¤‡åˆ—è¡¨:
  - mem0
    ç±»å‹: cxl-mem
    å†…å­˜: 536870912 bytes
```

**æ— CXLè®¾å¤‡æ—¶ï¼š**
```
[WARN] æœªæ£€æµ‹åˆ°CXLæ€»çº¿
[INFO] æç¤º: å¦‚æœæ˜¯CXLè™šæ‹Ÿæœºï¼Œè¯·ç¡®ä¿å†…æ ¸å·²å¯ç”¨CXLæ”¯æŒ
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šRedisæ— æ³•å¯åŠ¨

**ç°è±¡ï¼š**
```
[FAIL] RedisæœåŠ¡å™¨æœªè¿è¡Œ
```

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 6379

# ä½¿ç”¨å…¶ä»–ç«¯å£
./src/redis-server --port 6380 --daemonize yes
./test_composite_lru.sh 6380 60
```

### é—®é¢˜2ï¼šç­–ç•¥æœªåŠ è½½

**ç°è±¡ï¼š**
```
[WARN] æ— æ³•ä»æ—¥å¿—ç¡®è®¤ç­–ç•¥åŠ è½½çŠ¶æ€
```

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥Redisæ—¥å¿—
tail -100 /tmp/redis-test.log | grep -i "strategy\|lru"

# ç¡®è®¤ç¼–è¯‘åŒ…å«ç­–ç•¥æ¨¡å—
grep "numa_composite_lru" src/Makefile
```

### é—®é¢˜3ï¼šCXLè®¾å¤‡æœªæ£€æµ‹åˆ°

**ç°è±¡ï¼š**
```
[WARN] æœªæ£€æµ‹åˆ°CXLæ€»çº¿
```

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥å†…æ ¸é…ç½®
zcat /proc/config.gz | grep CXL

# æ‰‹åŠ¨åŠ è½½CXLæ¨¡å—
sudo modprobe cxl

# æ£€æŸ¥dmesg
dmesg | grep -i cxl
```

### é—®é¢˜4ï¼šNUMAMIGRATEå‘½ä»¤ä¸å¯ç”¨

**ç°è±¡ï¼š**
```
[WARN] NUMAMIGRATEå‘½ä»¤å¯èƒ½ä¸æ”¯æŒ
```

**è§£å†³ï¼š**
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœKeyè¿ç§»æ¨¡å—æœªå®Œå…¨é›†æˆ
- æ£€æŸ¥05æ–‡æ¡£ä¸­çš„NUMAMIGRATEå®ç°çŠ¶æ€

---

## é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰æµ‹è¯•å‚æ•°

```bash
# é•¿æ—¶é—´å‹åŠ›æµ‹è¯•ï¼ˆ10åˆ†é’Ÿï¼‰
./test_composite_lru_cxl.sh 6379 600

# æŒ‡å®šRedisé…ç½®æ–‡ä»¶
./src/redis-server ./redis.conf --daemonize yes
./test_composite_lru.sh 6379 60
```

### åˆ†ææµ‹è¯•ç»“æœ

```bash
# æå–æ€§èƒ½æ•°æ®
grep "OPS:" /tmp/composite_lru_cxl_test.log

# æå–é”™è¯¯ä¿¡æ¯
grep "\[FAIL\]" /tmp/composite_lru_cxl_test.log

# ç”Ÿæˆå›¾è¡¨æ•°æ®
awk '/OPS:/{print $3}' /tmp/composite_lru_cxl_test.log > ops_data.txt
```

### è‡ªåŠ¨åŒ–æµ‹è¯•

```bash
# åˆ›å»ºè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
cat > run_auto_test.sh << 'EOF'
#!/bin/bash
for duration in 60 120 300; do
    echo "Testing with duration=${duration}s"
    ./test_composite_lru_cxl.sh 6379 $duration
    sleep 10
done
EOF
chmod +x run_auto_test.sh
```

---

## æµ‹è¯•è„šæœ¬å¯¹æ¯”

| ç‰¹æ€§ | test_composite_lru.sh | test_composite_lru_cxl.sh |
|-----|----------------------|--------------------------|
| æ‰§è¡Œæ—¶é—´ | çŸ­ï¼ˆçº¦1-2åˆ†é’Ÿï¼‰ | è¾ƒé•¿ï¼ˆæ ¹æ®å‚æ•°ï¼‰ |
| CXLæ£€æµ‹ | åŸºç¡€æ£€æµ‹ | è¯¦ç»†æ£€æµ‹ |
| æ•°æ®å¯¹è±¡ | æ ‡å‡†å¤§å° | åˆ†å±‚å¤§å°ï¼ˆæ¨¡æ‹ŸCXLå±‚çº§ï¼‰ |
| è®¿é—®æ¨¡å¼ | ç®€å•çƒ­ç‚¹/å†·key | CXLæ„ŸçŸ¥ï¼ˆçƒ­ç‚¹/æ¸©/å†·ï¼‰ |
| æ€§èƒ½æµ‹è¯• | åŸºç¡€å‹åŠ›æµ‹è¯• | CXLä¼˜åŒ–å‹åŠ›æµ‹è¯• |
| æŠ¥å‘Šè¯¦ç»†åº¦ | æ ‡å‡† | è¯¦ç»†ï¼ˆå«ç³»ç»Ÿä¿¡æ¯ï¼‰ |
| é€‚ç”¨åœºæ™¯ | åŠŸèƒ½éªŒè¯ | CXLç¯å¢ƒæ€§èƒ½è¯„ä¼° |

---

## è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Redisæ—¥å¿—æ–‡ä»¶ï¼ˆ`/tmp/redis-*.log`ï¼‰
2. æµ‹è¯•è„šæœ¬æ—¥å¿—ï¼ˆ`/tmp/composite_lru*.log`ï¼‰
3. ç³»ç»Ÿdmesgæ—¥å¿—ï¼ˆ`dmesg | grep -i cxl`ï¼‰
