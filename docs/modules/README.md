# Redis NUMA 模块文档

本文档详细介绍 Redis NUMA 改造项目的二次开发模块。

## 模块概览

```
┌─────────────────────────────────────────────────────────────┐
│                    Redis Server                              │
├─────────────────────────────────────────────────────────────┤
│  Application Layer                                           │
│  - Redis Objects (robj, sds, dict, etc.)                    │
│  - Data Structures (string, list, hash, set, zset)          │
└──────────────────────────┬──────────────────────────────────┘
                           │ zmalloc/zfree
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  Memory Allocation Layer                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ zmalloc.c   │  │ numa_pool   │  │ numa_migrate        │  │
│  │ (NUMA适配)  │  │ (内存池)     │  │ (迁移模块)          │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
└─────────┼────────────────┼────────────────────┼─────────────┘
          │                │                    │
          ▼                ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│  System Layer                                                │
│  - libnuma (numa_alloc_onnode, numa_free)                   │
│  - libc (malloc, free, memcpy)                              │
└─────────────────────────────────────────────────────────────┘
```

## 模块列表

| 模块 | 文件 | 功能描述 | 状态 |
|------|------|----------|------|
| **NUMA内存池** | `numa_pool.h/c` | 节点粒度的内存池管理 | 已完成 v2.1 |
| **NUMA迁移** | `numa_migrate.h/c` | 内存对象跨节点迁移 | 已完成 v2.2 |
| **zmalloc NUMA适配** | `zmalloc.c/h` | 内存分配器NUMA感知改造 | 已完成 v2.0 |

## 核心设计原则

### 1. 向后兼容
- 所有现有Redis代码无需修改即可运行
- zmalloc接口保持完全不变
- NUMA不可用时自动回退到标准分配器

### 2. 模块化架构
- 职责分离：分配、池管理、迁移各自独立
- 接口清晰：通过头文件定义模块边界
- 易于扩展：支持未来libNUMA功能增强

### 3. 性能优先
- 内存池减少系统调用，提升6倍性能
- O(1)时间复杂度的内存分配
- 无锁设计（per-pool锁减少竞争）

## 文档导航

### 核心模块文档
- [01-numa-pool.md](./01-numa-pool.md) - NUMA内存池模块详解
- [02-numa-migrate.md](./02-numa-migrate.md) - NUMA迁移模块详解
- [03-zmalloc-numa.md](./03-zmalloc-numa.md) - zmalloc NUMA适配详解
- [04-call-chain.md](./04-call-chain.md) - 业务调用链分析

### Key级别迁移与策略框架
- [05-numa-key-migrate.md](./05-numa-key-migrate.md) - Key级别迁移核心模块
- [06-numa-strategy-slots.md](./06-numa-strategy-slots.md) - 策略插槽框架
- [07-numa-composite-lru.md](./07-numa-composite-lru.md) - 复合LRU策略实现

## 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v2.2 | 2026-02-13 | 添加迁移模块，模块化重构完成 |
| v2.1 | 2026-02-13 | 内存池模块化，分离为独立模块 |
| v2.0 | 2026-02-07 | 性能优化，166K req/s达成 |
| v1.0 | 2025-02 | 初始NUMA适配实现 |
